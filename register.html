<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Register Courier - Eri Shipping Hub</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
   body {
 background: linear-gradient(to bottom right, #0a3d62, #1e2a38);
  background-size: cover; /* Ensures the image covers the entire page */
  background-position: center center; /* Keeps the image centered */
  background-attachment: fixed; /* Keeps the background fixed during scrolling */
  min-height: 100vh;
  margin: 0; }

    .nav-brand {
      font-weight: 700;
      color: var(--bs-primary) !important; /* Use Bootstrap variable */
    }

    header h1, header p {
        text-shadow: 1px 1px 3px rgba(0,0,0,0.3); /* Optional: adds readability */
    }

    .card {
        background-color: rgba(255, 255, 255, 0.9); /* Slightly transparent cards */
        backdrop-filter: blur(5px); /* Optional: adds blur effect */
    }

    /* Style for validation feedback in placeholders */
    .form-control.is-invalid::placeholder {
        color: var(--bs-danger);
        opacity: 0.8;
    }
    /* Style Select2 when invalid */
    .select2-container--bootstrap-5 .select2-selection.is-invalid {
         border-color: var(--bs-danger) !important;
         padding-right: calc(1.5em + 0.75rem) !important;
         background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linecap='round' stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e") !important;
         background-repeat: no-repeat !important;
         background-position: right calc(0.375em + 0.1875rem) center !important;
         background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem) !important;
    }

     /* Adjust Select2 placeholder styles */
    .select2-container .select2-selection--single .select2-selection__placeholder {
        color: #6c757d !important;
        /* Add line height for vertical centering if needed */
         line-height: calc(1.5em + 0.75rem + 2px); /* Match Bootstrap form-control height */
    }
     .select2-container--bootstrap-5 .select2-selection {
        padding-top: 0.375rem !important; /* Match Bootstrap form-control padding */
        padding-bottom: 0.375rem !important; /* Match Bootstrap form-control padding */
        min-height: calc(1.5em + 0.75rem + 2px); /* Match Bootstrap form-control height */
        border: 1px solid #ced4da !important; /* Add standard bootstrap border */
        border-radius: var(--bs-border-radius); /* Use bootstrap border radius */
        display: flex; /* Use flexbox for alignment */
        align-items: center; /* Center vertically */
     }
     /* Adjust rendered text padding for Select2 */
      .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered {
         padding-left: 0.75rem !important; /* Standard bootstrap input padding-left */
         padding-right: 2.5rem !important; /* Make space for the arrow/clear */
         line-height: calc(1.5em + 0.75rem) !important; /* Adjust line height */
         color: #212529; /* Standard input text color */
         flex-grow: 1; /* Allow text to take available space */
         overflow: hidden; /* Hide overflowing text */
         text-overflow: ellipsis; /* Add ellipsis for overflow */
         white-space: nowrap; /* Prevent wrapping */
      }

      .select2-container--bootstrap-5 .select2-selection--single .select2-selection__arrow b {
         /* Adjust arrow position if needed based on padding/height */
         border-top-color: #888; /* Standard arrow color */
         border-width: 5px 4px 0 4px !important; /* Standard arrow size */
          top: 50% !important; /* Center vertically */
          transform: translateY(-50%); /* Fine-tune vertical alignment */
     }


     /* Loading Button State */
     .btn .spinner-border {
        display: none; /* Hidden by default */
        margin-right: .5rem;
     }
     .btn.loading .spinner-border {
        display: inline-block;
     }
     .btn.loading .button-text {
        visibility: hidden; /* Hide text while loading */
     }

     /* Style for invalid checkbox */
    .form-check-input.is-invalid ~ .form-check-label {
        color: var(--bs-danger);
    }


</style>

</head>
<body class="bg-light">
  <header class="py-4 mb-4">
    <div class="container">
      <h1 class="text-center mb-2">
        <i class="fas fa-shipping-fast"></i>
        <span class="nav-brand text-white">Eri Shipping Hub</span>
      </h1>
      <p class="text-center text-white-50">Our community, our courier</p>
    </div>
  </header>
  <div class="container py-5">
    <h2 class="text-center mb-4">
      <i class="fas fa-user-tie me-2 text-white"></i>
      <span style=" background: #0a3d62; color: white; padding: 0.5rem 1.5rem; border-radius: 1rem; display: inline-block; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      ">
       ምዝገባ ተጓዓዛይ
      </span>
    </h2>
    <div id="generalFeedback" class="alert alert-info alert-dismissible fade d-none mx-auto" role="alert" style="max-width: 600px;">
        <span id="generalFeedbackText"></span>
         <button type="button" class="btn-close" aria-label="Close"></button>
    </div>

    <form id="courierForm" class="card p-4 shadow-sm mx-auto" style="max-width: 600px; " novalidate> <div class="mb-3">
        <label for="name" class="form-label">ስም</label>
        <input type="text" id="name" class="form-control" placeholder="Your Name" required /> </div>
      <div class="mb-3">
         <label for="from" class="form-label">ካብ</label> <select id="from" class="form-select" required>
            <option value="" disabled selected>Select Origin Country</option> <option value="Ethiopia">🇪🇹 Ethiopia</option>
            <option value="Eritrea">🇪🇷 Eritrea</option>
            <option value="Uganda">🇺🇬 Uganda</option>
            <option value="Canada">🇨🇦 Canada</option>
            <option value="Turkey">🇹🇷 Turkey</option>
            <option value="Dubai">🇦🇪 Dubai</option>
            <option value="Kenya">🇰🇪 Kenya</option>
            <option value="Angola">🇦🇴 Angola</option>
            <option value="Switzerland">🇨🇭 Switzerland</option>
            <option value="Netherlands">🇳🇱 Netherlands</option>
            <option value="Belgium">🇧🇪 Belgium</option>
            <option value="Sweden">🇸🇪 Sweden</option>
            <option value="Germany">🇩🇪 Germany</option>
            <option value="USA">🇺🇸 USA</option>
            <option value="England">🇬🇧 England</option>
            <option value="Denmark">🇩🇰 Denmark</option>
            <option value="France">🇫🇷 France</option>
            <option value="Italy">🇮🇹 Italy</option>
            <option value="South Africa">🇿🇦 South Africa</option>
            <option value="Egypt">🇪🇬 Egypt</option>
          </select>
          </div>
      <div class="mb-3">
         <label for="to" class="form-label">ናብ</label> <select id="to" class="form-select" required>
            <option value="" disabled selected>Select Destination Country</option> <option value="Ethiopia">🇪🇹 Ethiopia</option>
            <option value="Eritrea">🇪🇷 Eritrea</option>
            <option value="Uganda">🇺🇬 Uganda</option>
            <option value="Canada">🇨🇦 Canada</option>
            <option value="Turkey">🇹🇷 Turkey</option>
            <option value="Dubai">🇦🇪 Dubai</option>
            <option value="Kenya">🇰🇪 Kenya</option>
            <option value="Angola">🇦🇴 Angola</option>
            <option value="Switzerland">🇨🇭 Switzerland</option>
            <option value="Netherlands">🇳🇱 Netherlands</option>
            <option value="Belgium">🇧🇪 Belgium</option>
            <option value="Sweden">🇸🇪 Sweden</option>
            <option value="Germany">🇩🇪 Germany</option>
            <option value="USA">🇺🇸 USA</option>
            <option value="England">🇬🇧 England</option>
            <option value="Denmark">🇩🇰 Denmark</option>
            <option value="France">🇫🇷 France</option>
            <option value="Italy">🇮🇹 Italy</option>
            <option value="South Africa">🇿🇦 South Africa</option>
            <option value="Egypt">🇪🇬 Egypt</option>
          </select>
          </div>
      <div class="mb-3">
        <label for="date" class="form-label">ዕለት መገሻ</label>
        <input type="date" id="date" class="form-control" placeholder="Select Departure Date" required /> </div>
      <div class="mb-3">
        <label for="contact" class="form-label">ቴሌ.</label>
        <input type="tel" id="contact" class="form-control" placeholder="e.g., +1 123 456 7890" required /> </div>
      <div class="mb-3">
        <label for="comments" class="form-label">Comments (Optional)</label>
        <textarea id="comments" class="form-control" placeholder="Any additional notes..."></textarea> </div>
      <div class="form-check mb-3">
        <input class="form-check-input" type="checkbox" id="terms" required>
        <label class="form-check-label" for="terms">
          I agree to the <a href="terms.html" target="_blank">Terms & Conditions</a>
        </label>
         </div>
      <button type="submit" class="btn btn-primary w-100">
         <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
         <span class="button-text">Submit</span>
      </button>
    </form>
  </div>

   <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>


  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp, query, where, getDocs  } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-firestore.js";
     // Import Auth if you plan to use it later for secure registration
    // import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.0.0/firebase-auth.js";


    // ACTUAL Firebase configuration provided by the user
    const firebaseConfig = {
      apiKey: "AIzaSyCapqLcvAVvBtSvUgtvLX4gx7nN5XSjAtQ",
      authDomain: "erishipping-e4532.firebaseapp.com",
      projectId: "erishipping-e4532",
      storageBucket: "erishipping-e4532.appspot.com",
      messagingSenderId: "388550131049",
      appId: "1:388550131049:web:e9ac1784ab8e5fabc811f8"
    };

    // Initialize Firebase ONLY if not already initialized
     const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApp();
    const db = getFirestore(app);
    // const auth = getAuth(app); // Initialize Auth if you plan to use it
    const courierRef = collection(db, "couriers");

    const form = document.getElementById("courierForm");
    const dateInput = document.getElementById("date");
    const submitBtn = form.querySelector('button[type="submit"]'); // Get the submit button

    // Get general feedback elements
    const generalFeedback = document.getElementById("generalFeedback");
    const generalFeedbackText = document.getElementById("generalFeedbackText");
    const feedbackCloseButton = generalFeedback.querySelector('.btn-close');


    // Store original placeholders for inputs (Select2 handled separately in init)
    const originalInputPlaceholders = {};
    form.querySelectorAll('input:not([type="checkbox"]), textarea').forEach(input => { // Exclude checkbox
        originalInputPlaceholders[input.id] = input.placeholder;
    });


    // --- UI Feedback Helpers (Integrated from Load Board with improvements) ---
    let feedbackHideTimeout = null; // To manage the timeout for hiding feedback

    function showGeneralFeedback(message, type = 'info', duration = 7000) { // Added duration parameter
        console.log(`[Feedback|SHOW] Showing: "${message}" (Type: ${type}, Duration: ${duration}ms) at ${new Date().toLocaleTimeString()}`);

        // Clear any existing hide timeout before showing a new message
        if (feedbackHideTimeout) {
            console.log(`[Feedback|SHOW] Clearing existing timeout ID: ${feedbackHideTimeout}`);
            clearTimeout(feedbackHideTimeout);
            feedbackHideTimeout = null; // Ensure it's null after clearing
            console.log("[Feedback|SHOW] Cleared previous hide timeout, variable is now null.");
        }

        // Remove d-none immediately to make the alert element visible for transitions
        generalFeedback.classList.remove('d-none');
        generalFeedback.classList.remove('alert-info', 'alert-success', 'alert-warning', 'alert-danger');
        generalFeedback.classList.add(`alert-${type}`);
        generalFeedbackText.textContent = message;

        // Force a reflow to ensure the removal of d-none is processed by the browser
        // before adding the 'show' class to trigger the fade-in.
        generalFeedback.offsetHeight; // Accessing offsetHeight forces a reflow
        console.log("[Feedback|SHOW] Forced reflow.");


        // Add 'show' class to trigger the fade-in transition
        generalFeedback.classList.add('show');
        console.log("[Feedback|SHOW] Added 'show' class.");


         // Set new hide timeout for automatic dismissal
         feedbackHideTimeout = setTimeout(() => {
             console.log(`[Feedback|TIMEOUT] Main timeout finished (${duration}ms). Calling hideGeneralFeedback.`);
             hideGeneralFeedback();
            }, duration); // Use dynamic duration
         console.log(`[Feedback|SHOW] Set new timeout ID: ${feedbackHideTimeout} for ${duration}ms.`);
    }

    function hideGeneralFeedback() {
        console.log(`[Feedback|HIDE] Hiding process started at ${new Date().toLocaleTimeString()}`);
        // Remove 'show' class to trigger the fade-out transition
        generalFeedback.classList.remove('show');
        console.log("[Feedback|HIDE] Removed 'show' class.");

        // After the fade-out transition duration, add the 'd-none' class to fully hide
        setTimeout(() => {
            console.log("[Feedback|HIDE|INNER_TIMEOUT] Adding 'd-none'.");
            generalFeedback.classList.add('d-none');
            console.log("[Feedback|HIDE|INNER_TIMEOUT] Added 'd-none'.");
        }, 300); // This duration should match Bootstrap's fade transition time
        console.log("[Feedback|HIDE] Set inner 300ms timeout for d-none.");
    }

     // Manually handle click on the close button
     feedbackCloseButton.addEventListener('click', () => {
         console.log("[Feedback|CLOSE_BTN] Close button clicked.");
         // Clear the automatic hide timeout if it exists before hiding manually
         if (feedbackHideTimeout) {
            console.log(`[Feedback|CLOSE_BTN] Clearing automatic timeout ID: ${feedbackHideTimeout}`);
            clearTimeout(feedbackHideTimeout);
            feedbackHideTimeout = null; // Ensure it's null after clearing
            console.log("[Feedback|CLOSE_BTN] Cleared automatic timeout, variable is now null.");
         }
         hideGeneralFeedback(); // Call our hide function
         console.log("[Feedback|CLOSE_BTN] Called hideGeneralFeedback.");
     });


     function setButtonLoadingState(button, isLoading) {
        if (isLoading) {
            button.classList.add('loading');
            button.disabled = true;
        } else {
            button.classList.remove('loading');
            button.disabled = false;
        }
    }

    // Refined setValidationFeedback to only add/remove is-invalid class
    function setValidationFeedback(inputElement, message = '') {
        // Apply is-invalid class directly
        if (message) {
            inputElement.classList.add('is-invalid');
            // Note: For standard inputs/textareas, placeholder won't change,
            // rely on browser's validation messages or Bootstrap's :invalid pseudo-class styles.
            // For Select2, is-invalid class is applied to the hidden select, CSS targets the visible div.
            // For checkbox, is-invalid on input, CSS targets label.
        } else {
            inputElement.classList.remove('is-invalid');
        }
    }

    function clearAllValidationFeedback() {
        form.querySelectorAll('.form-control, .form-select, .form-check-input').forEach(input => { // Include checkbox
            setValidationFeedback(input, ''); // Clear feedback for all fields
        });
         // Explicitly remove was-validated class from the form itself
        form.classList.remove('was-validated');
    }


    // --- Date Handling ---
    // Set min date to today (local time) for date input
     const setMinDate = () => {
         const now = new Date();
         const year = now.getFullYear();
         const month = (now.getMonth() + 1).toString().padStart(2, '0');
         const day = now.getDate().toString().padStart(2, '0');
         dateInput.min = `${year}-${month}-${day}`;
         console.log(`Min date for #date input set to: ${dateInput.min}`);
     };
    setMinDate(); // Set min date on page load


    // --- Form Submission ---
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      console.log("Form submitted."); // Debug log

      // Hide any previous general message
      hideGeneralFeedback();
      // Clear previous validation errors and restore placeholders (now just removes is-invalid)
      clearAllValidationFeedback();

      const name = form.name.value.trim();
      const from = form.from.value.trim();
      const to = form.to.value.trim();
      const date = form.date.value; //YYYY-MM-DD string
      const contact = form.contact.value.trim();
      const comments = form.comments.value.trim();
      const termsChecked = form.terms.checked;

      console.log("Form Data:", { name, from, to, date, contact, comments, termsChecked }); // Debug log


      let isValid = true;
      // Client-Side Validation - Apply is-invalid and set isValid = false
      if (!name) { setValidationFeedback(form.name, "Name is required."); isValid = false; }
      if (!from) { setValidationFeedback(form.from, "Origin is required."); isValid = false; }
      if (!to) { setValidationFeedback(form.to, "Destination is required."); isValid = false; }

      if (!date) {
           setValidationFeedback(form.date, "Date is required."); isValid = false;
      } else {
           // Check future date - use local time comparison since date input uses local time
           const selectedLocalDate = new Date(date + 'T00:00:00'); // Interpret YYYY-MM-DD in local timezone
           const now = new Date();
           const todayLocal = new Date(now.getFullYear(), now.getMonth(), now.getDate()); // Today in local timezone
           if (selectedLocalDate < todayLocal) {
                setValidationFeedback(form.date, "Must be a future date."); isValid = false;
           }
      }

      // Basic phone validation (at least 7 digits, allows +, -, spaces)
      if (!contact || !/^\+?[0-9\s-]{7,}$/.test(contact)) {
           setValidationFeedback(form.contact, "Valid phone req'd (min 7 digits)."); isValid = false;
      }

      // Simple comment validation (check for common invalid characters)
       if (/http|www|@|%|tel:|mailto:/.test(comments)) {
           setValidationFeedback(form.comments, "Invalid characters in comment."); isValid = false;
       }

       if (!termsChecked) {
           setValidationFeedback(form.terms, "You must agree to terms."); isValid = false;
       }

       // Apply Bootstrap's was-validated class if form is invalid to show feedback
       if (!isValid) {
           console.log("Client-side validation failed."); // Debug log
           form.classList.add('was-validated');
           showGeneralFeedback("Please fill out all required fields and fix the errors.", "warning", 10000); // Show warning for 10s
           return; // Stop submission if client-side validation fails
       }

       console.log("Client-side validation passed."); // Debug log
       form.classList.remove('was-validated'); // Remove was-validated on successful validation

      // Cooldown Check (Client-side only - easily bypassed)
      const lastSubmission = localStorage.getItem("lastCourierSubmit");
      // Correct calculation for 2 hours in milliseconds (2 * 60 minutes * 60 seconds * 1000 milliseconds)
      const cooldownDuration = 2 * 60 * 60 * 1000;
      const nowTime = Date.now(); // Use a different variable name to avoid conflict with date object 'now'

      if (lastSubmission && nowTime - parseInt(lastSubmission) < cooldownDuration) {
        const remainingTime = cooldownDuration - (nowTime - parseInt(lastSubmission));
        const minutes = Math.ceil(remainingTime / (60 * 1000)); // Calculate minutes remaining
        console.log(`Cooldown active. ${minutes} minutes remaining.`); // Debug log
        showGeneralFeedback(`⏳ Please wait ${minutes} more minute(s) before submitting again.`, "warning", 10000); // Show warning for 10s
        return;
      }
       console.log("Cooldown check passed."); // Debug log


      setButtonLoadingState(submitBtn, true); // Show loading state

      try {
        // Duplicate Check
        console.log("Checking for duplicates..."); // Debug log
        const duplicateCheckQuery = query(
          courierRef,
          where("from", "==", from),
          where("to", "==", to),
          where("date", "==", date),
          where("contact", "==", contact)
           // Optional: Include name in duplicate check?
           // where("name", "==", name)
        );

        const duplicateSnap = await getDocs(duplicateCheckQuery);
        console.log("Duplicate check result:", duplicateSnap.size, "documents found."); // Debug log


        if (!duplicateSnap.empty) {
           console.log("Duplicate found!"); // Debug log
           showGeneralFeedback("⚠️ This exact courier entry (route, date, contact) seems to be already registered.", "warning", 15000); // Show warning for 15s
           setButtonLoadingState(submitBtn, false);
           return;
        }

        console.log("No duplicate found. Adding document..."); // Debug log
        // Add Courier Data to Firestore (Anonymous write - **Requires Firestore Rules**)
        const data = {
          name,
          from,
          to,
          date, // Store as YYYY-MM-DD string
          contact,
          comments,
          createdAt: serverTimestamp()
          // Optional: Add user ID if using Firebase Auth
          // userId: auth.currentUser ? auth.currentUser.uid : null,
        };

        await addDoc(courierRef, data);
        console.log("Document added successfully."); // Debug log
        localStorage.setItem("lastCourierSubmit", nowTime); // Update cooldown time in local storage


        // Reset form on success
        form.reset();
         // Reset Select2 values and trigger change to clear validation styles/placeholders
         $('#from').val(null).trigger('change');
         $('#to').val(null).trigger('change');
         clearAllValidationFeedback(); // Ensure is-invalid classes are removed
         setMinDate(); // Reset min date input

        showGeneralFeedback("✅ Courier registered successfully! Thank you.", "success", 7000); // Show success for 7s

      } catch (error) {
        console.error("Error registering courier:", error);
        showGeneralFeedback(`❌ Failed to register courier: ${error.message}. Please check console for details.`, "danger", 15000); // Show error for 15s
      } finally {
        setButtonLoadingState(submitBtn, false); // Hide loading state
      }
    });


    // --- Initialize Select2 ---
     $(document).ready(function() {
        // Store initial placeholders for Select2 elements
         const originalSelectPlaceholders = {};
         form.querySelectorAll('select').forEach(select => {
             const selectedOption = select.querySelector('option[disabled][selected]');
             if (selectedOption) {
                originalSelectPlaceholders[select.id] = selectedOption.textContent;
             }
         });

        $('#from').select2({ placeholder: originalSelectPlaceholders['from'] || 'Select Origin Country', theme: 'bootstrap-5' });
        $('#to').select2({ placeholder: originalSelectPlaceholders['to'] || 'Select Destination Country', theme: 'bootstrap-5' });

         // Watch Select2 changes to remove is-invalid class
         $('#from, #to').on('change', function() {
             // Use setValidationFeedback for consistency
             setValidationFeedback(this, this.value ? '' : 'required'); // Clear if value exists, mark invalid if cleared and required
         });

          // Watch terms checkbox changes to remove is-invalid class
         $('#terms').on('change', function() {
             setValidationFeedback(this, ''); // Clear validation feedback when checked/unchecked
         });

         // Add input event listeners for instant validation feedback clearing for standard inputs
         form.querySelectorAll('input:not([type="checkbox"]), textarea').forEach(input => {
             input.addEventListener('input', () => {
                 setValidationFeedback(input, ''); // Clear validation feedback on input
             });
         });

         console.log("Select2 initialized and input event listeners added."); // Debug log

      });

  </script>
</body>
</html>
