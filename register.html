<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Post Trip | Eri Shipping Hub</title>
  <link rel="icon" href="android-chrome-512x512.png" type="image/png">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <style>
    :root {
       --app-primary: #0a3d62; /* Dark Blue */
       --app-secondary: #1e90ff; /* Light Blue */
    }

    body {
      background-image: url('https://raw.githubusercontent.com/bini2024/Eri-shipping-Hub/refs/heads/main/Erishipping.jpg');
      background-size: cover;
      background-position: center center;
      background-attachment: fixed;
      min-height: 100vh;
      margin: 0;
      padding-bottom: 80px; /* Space for bottom nav */
    }

    /* --- Typography & Header --- */
    header h1 .nav-brand {
         color: var(--app-secondary) !important;
         font-weight: 700;
     }
     header h1, header p {
         text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
         color: var(--app-primary) !important; 
     }
     header {
         background: none !important;
     }

    /* --- Form Card Styles --- */
    .card {
        background-color: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(8px);
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        border-top: 5px solid var(--app-secondary);
    }

    .form-label {
        font-weight: 600;
        color: var(--app-primary);
    }

    /* --- Inputs & Buttons --- */
    .form-control:focus, .form-select:focus {
      border-color: var(--app-primary);
      box-shadow: 0 0 0 0.25rem rgba(10, 61, 98, 0.25);
    }
    .btn-primary {
      background-color: var(--app-primary);
      border-color: var(--app-primary);
      font-weight: bold;
      padding: 12px;
    }
    .btn-primary:hover {
      background-color: var(--app-secondary);
      border-color: var(--app-secondary);
    }

    /* --- Select2 Customization --- */
    .select2-container--bootstrap-5 .select2-selection {
        border-color: #ced4da;
        padding-top: 0.4rem;
        padding-bottom: 0.4rem;
    }
    .select2-container--bootstrap-5 .select2-selection.is-invalid {
        border-color: #dc3545 !important;
    }

    /* --- Loading State --- */
    .btn .spinner-border { display: none; margin-right: 0.5rem; }
    .btn.loading .spinner-border { display: inline-block; }
    .btn.loading .button-text { display: none; }

    /* --- Bottom Navigation Bar --- */
    .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background-color: var(--app-primary);
        display: flex;
        justify-content: space-around;
        align-items: center;
        padding: 10px 0;
        z-index: 2000;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        border-top: 1px solid rgba(255,255,255,0.1);
    }
    .bottom-nav a {
        color: rgba(255,255,255,0.6);
        text-decoration: none;
        text-align: center;
        font-size: 0.8rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        transition: color 0.3s;
    }
    .bottom-nav a i {
        font-size: 1.2rem;
        margin-bottom: 4px;
    }
    .bottom-nav a:hover, .bottom-nav a.active {
        color: white;
    }
    .bottom-nav a.active i {
        color: var(--app-secondary);
    }

    /* Logo */
    #siteLogo {
       position: fixed;
       top: 16px;
       left: 16px;
       width: 48px;
       height: auto;
       z-index: 1000;
    }
  </style>
</head>
<body>

  <header class="py-4 mb-2">
    <div class="container text-center">
        <img id="siteLogo" src="1000072056-removebg-preview.png" alt="Eri Shipping Hub Logo">
      <h1 class="mb-2">
        <i class="fas fa-shipping-fast" style="color: var(--app-primary);"></i>
        <span class="nav-brand">Eri Shipping Hub</span>
      </h1>
      <p>Our community, our courier</p>
    </div>
  </header>

  <div class="container">
    <div id="generalFeedback" class="alert alert-info alert-dismissible fade d-none mx-auto" role="alert" style="max-width: 600px;">
        <span id="generalFeedbackText"></span>
        <button type="button" class="btn-close" aria-label="Close"></button>
    </div>

    <div class="card p-4 shadow-sm mx-auto mb-5" style="max-width: 600px;">
        <h3 class="text-center mb-4" style="color: var(--app-primary); font-weight: 700;">
            <i class="fas fa-plane-departure me-2"></i>Post Trip (áˆá‹áŒˆá‰£)
        </h3>
        
        <form id="courierForm" novalidate>
            <div class="mb-3">
                <label for="name" class="form-label">Name (áˆµáˆ)</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-user"></i></span>
                    <input type="text" id="name" class="form-control" placeholder="Your Full Name" required />
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="from" class="form-label">From (áŠ«á‰¥)</label>
                    <select id="from" class="form-select" required>
                        <option value="" disabled selected>Select Origin</option>
                        <option value="Ethiopia">ğŸ‡ªğŸ‡¹ Ethiopia</option>
                         <option value="Eritrea">ğŸ‡ªğŸ‡· Eritrea</option>
                         <option value="Uganda">ğŸ‡ºğŸ‡¬ Uganda</option>
                         <option value="Canada">ğŸ‡¨ğŸ‡¦ Canada</option>
                         <option value="Turkey">ğŸ‡¹ğŸ‡· Turkey</option>
                         <option value="Dubai">ğŸ‡¦ğŸ‡ª Dubai</option>
                         <option value="Kenya">ğŸ‡°ğŸ‡ª Kenya</option>
                         <option value="Angola">ğŸ‡¦ğŸ‡´ Angola</option>
                         <option value="Switzerland">ğŸ‡¨ğŸ‡­ Switzerland</option>
                         <option value="Netherlands">ğŸ‡³ğŸ‡± Netherlands</option>
                         <option value="Belgium">ğŸ‡§ğŸ‡ª Belgium</option>
                         <option value="Sweden">ğŸ‡¸ğŸ‡ª Sweden</option>
                         <option value="Germany">ğŸ‡©ğŸ‡ª Germany</option>
                         <option value="USA">ğŸ‡ºğŸ‡¸ USA</option>
                         <option value="England">ğŸ‡¬ğŸ‡§ England</option>
                         <option value="Denmark">ğŸ‡©ğŸ‡° Denmark</option>
                         <option value="France">ğŸ‡«ğŸ‡· France</option>
                         <option value="Italy">ğŸ‡®ğŸ‡¹ Italy</option>
                         <option value="South Africa">ğŸ‡¿ğŸ‡¦ South Africa</option>
                         <option value="Egypt">ğŸ‡ªğŸ‡¬ Egypt</option>
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="to" class="form-label">To (áŠ“á‰¥)</label>
                    <select id="to" class="form-select" required>
                        <option value="" disabled selected>Select Destination</option>
                        <option value="Ethiopia">ğŸ‡ªğŸ‡¹ Ethiopia</option>
                         <option value="Eritrea">ğŸ‡ªğŸ‡· Eritrea</option>
                         <option value="Uganda">ğŸ‡ºğŸ‡¬ Uganda</option>
                         <option value="Canada">ğŸ‡¨ğŸ‡¦ Canada</option>
                         <option value="Turkey">ğŸ‡¹ğŸ‡· Turkey</option>
                         <option value="Dubai">ğŸ‡¦ğŸ‡ª Dubai</option>
                         <option value="Kenya">ğŸ‡°ğŸ‡ª Kenya</option>
                         <option value="Angola">ğŸ‡¦ğŸ‡´ Angola</option>
                         <option value="Switzerland">ğŸ‡¨ğŸ‡­ Switzerland</option>
                         <option value="Netherlands">ğŸ‡³ğŸ‡± Netherlands</option>
                         <option value="Belgium">ğŸ‡§ğŸ‡ª Belgium</option>
                         <option value="Sweden">ğŸ‡¸ğŸ‡ª Sweden</option>
                         <option value="Germany">ğŸ‡©ğŸ‡ª Germany</option>
                         <option value="USA">ğŸ‡ºğŸ‡¸ USA</option>
                         <option value="England">ğŸ‡¬ğŸ‡§ England</option>
                         <option value="Denmark">ğŸ‡©ğŸ‡° Denmark</option>
                         <option value="France">ğŸ‡«ğŸ‡· France</option>
                         <option value="Italy">ğŸ‡®ğŸ‡¹ Italy</option>
                         <option value="South Africa">ğŸ‡¿ğŸ‡¦ South Africa</option>
                         <option value="Egypt">ğŸ‡ªğŸ‡¬ Egypt</option>
                    </select>
                </div>
            </div>

            <div class="mb-3">
                <label for="date" class="form-label">Date (á‹•áˆˆá‰µ áˆ˜áŒˆáˆ»)</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                    <input type="date" id="date" class="form-control" required />
                </div>
            </div>

            <div class="mb-3">
                <label for="contact" class="form-label">Phone (á‰´áˆŒááŠ•)</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-phone"></i></span>
                    <input type="tel" id="contact" class="form-control" placeholder="+1 234 567 8900" required />
                </div>
                <small class="text-muted">Include country code (e.g., +1, +251)</small>
            </div>

            <div class="mb-3">
                <label for="comments" class="form-label">Comments (Optional)</label>
                <textarea id="comments" class="form-control" rows="2" placeholder="Example: I have 10kg available..."></textarea>
            </div>

            <div class="form-check mb-4">
                <input class="form-check-input" type="checkbox" id="terms" required>
                <label class="form-check-label" for="terms">
                   I agree to the <a href="terms.html" target="_blank" style="color:var(--app-secondary); font-weight:bold;">Terms & Conditions</a>
                </label>
            </div>

            <button type="submit" class="btn btn-primary w-100 py-3 fs-5 rounded-pill shadow-sm">
                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                <span class="button-text"><i class="fas fa-paper-plane me-2"></i> Register Trip</span>
            </button>
        </form>
    </div>
  </div>

  <nav class="bottom-nav">
      <a href="index.html">
          <i class="fas fa-home"></i>
          Home
      </a>
      <a href="register.html" class="active">
          <i class="fas fa-plane-departure"></i>
          Post Trip
      </a>
      <a href="load-board.html">
          <i class="fas fa-box-open"></i>
          Load Board
      </a>
      <a href="https://t.me/Erishipping" target="_blank">
          <i class="fab fa-telegram-plane"></i>
          Support
      </a>
  </nav>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCapqLcvAVvBtSvUgtvLX4gx7nN5XSjAtQ",
      authDomain: "erishipping-e4532.firebaseapp.com",
      projectId: "erishipping-e4532",
      storageBucket: "erishipping-e4532.firebasestorage.app",
      messagingSenderId: "388550131049",
      appId: "1:388550131049:web:e9ac1784ab8e5fabc811f8"
    };

    const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApp();
    const db = getFirestore(app);
    const courierRef = collection(db, "couriers");

    const form = document.getElementById("courierForm");
    const dateInput = document.getElementById("date");
    const submitBtn = form.querySelector('button[type="submit"]');
    const generalFeedback = document.getElementById("generalFeedback");
    const generalFeedbackText = document.getElementById("generalFeedbackText");
    const feedbackCloseButton = generalFeedback.querySelector('.btn-close');

    let feedbackHideTimeout = null;

    function showGeneralFeedback(message, type = 'info', duration = 7000) {
        if (feedbackHideTimeout) clearTimeout(feedbackHideTimeout);
        generalFeedback.classList.remove('d-none', 'alert-info', 'alert-success', 'alert-warning', 'alert-danger');
        generalFeedback.classList.add(`alert-${type}`, 'show');
        generalFeedbackText.textContent = message;
        
        feedbackHideTimeout = setTimeout(() => {
            hideGeneralFeedback();
        }, duration);
    }

    function hideGeneralFeedback() {
        generalFeedback.classList.remove('show');
        setTimeout(() => generalFeedback.classList.add('d-none'), 300);
    }

    feedbackCloseButton.addEventListener('click', hideGeneralFeedback);

    function setButtonLoadingState(button, isLoading) {
        if (isLoading) {
            button.classList.add('loading');
            button.disabled = true;
        } else {
            button.classList.remove('loading');
            button.disabled = false;
        }
    }

    function setValidationFeedback(inputElement, message = '') {
        if (message) {
            inputElement.classList.add('is-invalid');
        } else {
            inputElement.classList.remove('is-invalid');
        }
    }

    // Set Min Date to Today
    const now = new Date();
    const year = now.getFullYear();
    const month = (now.getMonth() + 1).toString().padStart(2, '0');
    const day = now.getDate().toString().padStart(2, '0');
    dateInput.min = `${year}-${month}-${day}`;

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      hideGeneralFeedback();
      form.classList.remove('was-validated');

      const name = form.name.value.trim();
      const from = form.from.value.trim();
      const to = form.to.value.trim();
      const date = form.date.value; 
      const contact = form.contact.value.trim();
      const comments = form.comments.value.trim();
      const termsChecked = form.terms.checked;

      let isValid = true;
      if (!name) { setValidationFeedback(form.name, "Req"); isValid = false; } else setValidationFeedback(form.name, "");
      if (!from) { setValidationFeedback(form.from, "Req"); isValid = false; }
      if (!to) { setValidationFeedback(form.to, "Req"); isValid = false; }
      if (!date) { setValidationFeedback(form.date, "Req"); isValid = false; } else setValidationFeedback(form.date, "");
      if (!contact || contact.length < 7) { setValidationFeedback(form.contact, "Req"); isValid = false; } else setValidationFeedback(form.contact, "");
      if (!termsChecked) { setValidationFeedback(form.terms, "Req"); isValid = false; }

      if (!isValid) {
          showGeneralFeedback("Please fill all required fields.", "warning");
          return;
      }

      setButtonLoadingState(submitBtn, true);

      try {
        // Cooldown Check
        const lastSubmission = localStorage.getItem("lastCourierSubmit");
        const cooldownDuration = 2 * 60 * 60 * 1000; // 2 Hours
        const nowTime = Date.now();

        if (lastSubmission && nowTime - parseInt(lastSubmission) < cooldownDuration) {
             const minutes = Math.ceil((cooldownDuration - (nowTime - parseInt(lastSubmission))) / 60000);
             throw new Error(`Please wait ${minutes} minutes before posting again.`);
        }

        // Duplicate Check
        const duplicateQuery = query(
             courierRef,
             where("from", "==", from),
             where("to", "==", to),
             where("date", "==", date),
             where("contact", "==", contact)
        );
        const duplicateSnap = await getDocs(duplicateQuery);
        if (!duplicateSnap.empty) {
            throw new Error("You have already posted this trip.");
        }

        // Save
        await addDoc(courierRef, {
             name, from, to, date, contact, comments,
             createdAt: serverTimestamp()
        });

        localStorage.setItem("lastCourierSubmit", nowTime);
        form.reset();
        $('#from, #to').val(null).trigger('change');
        showGeneralFeedback("âœ… Trip posted successfully! Thank you.", "success");

      } catch (error) {
        console.error(error);
        showGeneralFeedback(error.message, "danger");
      } finally {
        setButtonLoadingState(submitBtn, false);
      }
    });

    // Initialize Select2
    $(document).ready(function() {
        $('#from, #to').select2({ theme: 'bootstrap-5', width: '100%' });
        
        $('#from, #to').on('change', function() {
            if($(this).val()) setValidationFeedback(this, '');
        });
        
        form.querySelectorAll('input').forEach(input => {
             input.addEventListener('input', () => setValidationFeedback(input, ''));
        });
    });
  </script>
</body>
</html>
