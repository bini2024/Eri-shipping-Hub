<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - Eri Shipping Hub</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="icon" type="image/png" href="android-chrome-512x512.png">
  
  <style>
      body { background-color: #f8f9fa; }
      .table th { font-weight: 600; color: #0a3d62; }
      .nav-tabs .nav-link.active {
          color: #0a3d62;
          font-weight: bold;
          border-top: 3px solid #0a3d62;
      }
      .nav-link { color: #6c757d; }
      
      /* Badges */
      .badge-ref { background-color: #ffc107; color: #000; }
      .badge-price { background-color: #198754; color: white; font-size: 0.9em; }

      /* Loading State */
      .btn .spinner-border { display: none; margin-right: .5rem; }
      .btn.loading .spinner-border { display: inline-block; }
      .btn.loading .button-text { display: none; }
  </style>
</head>
<body>
  <div class="container mt-5 pb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="text-dark"><i class="fas fa-user-shield me-2"></i>Admin Panel</h3>
        <button id="logoutBtn" class="btn btn-sm btn-outline-danger">
            <i class="fas fa-sign-out-alt me-1"></i>Logout
        </button>
    </div>

    <div id="generalFeedback" class="alert alert-info alert-dismissible fade show d-none" role="alert">
        <span id="generalFeedbackText"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>

    <div id="adminContent" style="display: none;"> 
      
      <ul class="nav nav-tabs mb-3" id="adminTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="couriers-tab" data-bs-toggle="tab" data-bs-target="#couriers" type="button" role="tab">
            <i class="fas fa-plane me-1"></i> Couriers
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="loads-tab" data-bs-toggle="tab" data-bs-target="#loads" type="button" role="tab">
            <i class="fas fa-box me-1"></i> Loads
          </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="cargo-tab" data-bs-toggle="tab" data-bs-target="#cargo" type="button" role="tab">
              <i class="fas fa-ship me-1"></i> Cargo Requests
            </button>
          </li>
      </ul>

      <div class="tab-content shadow-sm p-3 bg-white rounded" id="adminTabsContent">
        
        <div class="tab-pane fade show active" id="couriers" role="tabpanel">
          <div class="table-responsive">
             <table class="table table-hover align-middle">
               <thead>
                 <tr>
                   <th>Name</th>
                   <th>Route</th>
                   <th>Date</th>
                   <th>Contact</th>
                   <th>Comment</th>
                   <th>Posted</th>
                   <th>Actions</th>
                 </tr>
               </thead>
               <tbody id="couriersTableBody">
                 <tr><td colspan="7" class="text-center text-muted">Loading couriers...</td></tr>
               </tbody>
             </table>
          </div>
        </div>

        <div class="tab-pane fade" id="loads" role="tabpanel">
            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead>
                  <tr>
                    <th>From</th>
                    <th>To</th>
                    <th>Weight</th>
                    <th>Deadline</th>
                    <th>Contact</th>
                    <th>Note</th>
                    <th>Posted</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="loadsTableBody">
                  <tr><td colspan="8" class="text-center text-muted">Loading loads...</td></tr>
                </tbody>
              </table>
            </div>
        </div>

        <div class="tab-pane fade" id="cargo" role="tabpanel">
            <div class="table-responsive">
              <table class="table table-hover align-middle">
                <thead>
                  <tr>
                    <th>Ref #</th>
                    <th>Customer</th>
                    <th>Location / Pickup</th>
                    <th>Cargo Details</th>
                    <th>Rate</th>
                    <th>Receiver</th>
                    <th>Posted</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="cargoTableBody">
                  <tr><td colspan="8" class="text-center text-muted">Loading cargo requests...</td></tr>
                </tbody>
              </table>
            </div>
        </div>

      </div>
    </div> 
    
    <div id="authMessage" class="alert alert-warning text-center" role="alert" style="display:none;">
        <i class="fas fa-lock me-2"></i> Access denied. Please log in with an administrator account.
    </div>

  </div> 

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script> 
  
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, onSnapshot, deleteDoc, doc, orderBy, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCapqLcvAVvBtSvUgtvLX4gx7nN5XSjAtQ",
      authDomain: "erishipping-e4532.firebaseapp.com",
      projectId: "erishipping-e4532",
      storageBucket: "erishipping-e4532.appspot.com",
      messagingSenderId: "388550131049",
      appId: "1:388550131049:web:e9ac1784ab8e5fabc811f8"
    };

    const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApp();
    const db = getFirestore(app);
    const auth = getAuth(app);

    // References
    const courierCollection = collection(db, "couriers");
    const loadsCollection = collection(db, "loads");
    const cargoCollection = collection(db, "cargo_requests");

    // Elements
    const adminContent = document.getElementById('adminContent');
    const authMessage = document.getElementById('authMessage');
    const couriersTableBody = document.getElementById('couriersTableBody');
    const loadsTableBody = document.getElementById('loadsTableBody');
    const cargoTableBody = document.getElementById('cargoTableBody');
    const generalFeedback = document.getElementById("generalFeedback");
    const generalFeedbackText = document.getElementById("generalFeedbackText");

    // --- Admin Check ---
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // REPLACE THIS STRING WITH YOUR ACTUAL ADMIN UID FROM FIREBASE CONSOLE
        const adminUIDs = ['Yma9sAvJqObTmZ6BPFwhOsicasa2']; 
        
        if (adminUIDs.includes(user.uid)) {
          authMessage.style.display = 'none';
          adminContent.style.display = 'block';
          loadAdminData();
        } else {
          authMessage.style.display = 'block';
          adminContent.style.display = 'none';
        }
      } else {
        window.location.href = "login.html"; // Redirect if not logged in
      }
    });

    // --- Load Data ---
    function loadAdminData() {
      // 1. Couriers
      onSnapshot(query(courierCollection, orderBy('createdAt', 'desc')), (snapshot) => {
        couriersTableBody.innerHTML = snapshot.empty ? `<tr><td colspan="7" class="text-center text-muted">No couriers.</td></tr>` : "";
        snapshot.forEach(doc => {
            const data = doc.data();
            const dateStr = data.createdAt ? new Date(data.createdAt.toDate()).toLocaleDateString() : "-";
            couriersTableBody.innerHTML += `
            <tr>
                <td class="fw-bold">${data.name || "-"}</td>
                <td>${data.from} <i class="fas fa-arrow-right text-muted small"></i> ${data.to}</td>
                <td>${data.date}</td>
                <td>${data.contact}</td>
                <td class="small text-muted">${data.comments || ""}</td>
                <td class="small">${dateStr}</td>
                <td><button class="btn btn-sm btn-outline-danger delete-btn" data-id="${doc.id}" data-col="couriers"><i class="fas fa-trash"></i></button></td>
            </tr>`;
        });
      });

      // 2. Loads
      onSnapshot(query(loadsCollection, orderBy('createdAt', 'desc')), (snapshot) => {
        loadsTableBody.innerHTML = snapshot.empty ? `<tr><td colspan="8" class="text-center text-muted">No loads.</td></tr>` : "";
        snapshot.forEach(doc => {
            const data = doc.data();
            const dateStr = data.createdAt ? new Date(data.createdAt.toDate()).toLocaleDateString() : "-";
            loadsTableBody.innerHTML += `
            <tr>
                <td>${data.from}</td>
                <td>${data.to}</td>
                <td>${data.weight}kg</td>
                <td class="text-danger">${data.deadline}</td>
                <td>${data.phone}</td>
                <td class="small text-muted">${data.comment || ""}</td>
                <td class="small">${dateStr}</td>
                <td><button class="btn btn-sm btn-outline-danger delete-btn" data-id="${doc.id}" data-col="loads"><i class="fas fa-trash"></i></button></td>
            </tr>`;
        });
      });

      // 3. Cargo Requests (NEW)
      onSnapshot(query(cargoCollection, orderBy('createdAt', 'desc')), (snapshot) => {
        cargoTableBody.innerHTML = snapshot.empty ? `<tr><td colspan="8" class="text-center text-muted">No cargo requests.</td></tr>` : "";
        snapshot.forEach(doc => {
            const data = doc.data();
            const dateStr = data.createdAt ? new Date(data.createdAt.toDate()).toLocaleDateString() : "-";
            
            cargoTableBody.innerHTML += `
            <tr>
                <td><span class="badge badge-ref">${data.refNum || "N/A"}</span></td>
                <td>
                    <div class="fw-bold">${data.name}</div>
                    <div class="small text-muted"><i class="fas fa-phone-alt"></i> ${data.phone}</div>
                </td>
                <td>
                    <div class="fw-bold text-primary">${data.city}</div>
                    <div class="small text-muted" style="max-width:150px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${data.address}">${data.address}</div>
                </td>
                <td>
                    <div class="fw-bold">${data.quantity} x ${data.itemType}</div>
                </td>
                <td><span class="badge badge-price">${data.estimatedPrice || "Quote"}</span></td>
                <td>${data.receiver || "-"}</td>
                <td class="small">${dateStr}</td>
                <td><button class="btn btn-sm btn-outline-danger delete-btn" data-id="${doc.id}" data-col="cargo_requests"><i class="fas fa-trash"></i></button></td>
            </tr>`;
        });
      });
    }

    // --- Delete Logic ---
    document.addEventListener('click', async (e) => {
        const btn = e.target.closest('.delete-btn');
        if (!btn) return;

        const id = btn.dataset.id;
        const col = btn.dataset.col;
        let colRef;

        if (col === "couriers") colRef = courierCollection;
        else if (col === "loads") colRef = loadsCollection;
        else if (col === "cargo_requests") colRef = cargoCollection;

        if (confirm("Permanently delete this entry?")) {
            // Show loading spinner
            btn.classList.add('loading');
            
            try {
                await deleteDoc(doc(colRef, id));
                showFeedback("Deleted successfully.", "success");
            } catch (err) {
                console.error(err);
                showFeedback("Error deleting: " + err.message, "danger");
                btn.classList.remove('loading');
            }
        }
    });

    // --- Logout ---
    document.getElementById('logoutBtn').addEventListener('click', () => {
        signOut(auth).then(() => window.location.href = "login.html");
    });

    function showFeedback(msg, type) {
        generalFeedback.className = `alert alert-${type} fade show fixed-top m-3 mx-auto`;
        generalFeedback.style.maxWidth = "500px";
        generalFeedback.style.zIndex = "3000";
        generalFeedbackText.textContent = msg;
        generalFeedback.classList.remove('d-none');
        setTimeout(() => generalFeedback.classList.add('d-none'), 4000);
    }
  </script>
</body>
</html>
