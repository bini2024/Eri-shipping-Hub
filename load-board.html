<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Load Board | Eri Shipping Hub</title>
  <link rel="icon" href="android-chrome-512x512.png" type="image/png">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    :root {
       --app-primary: #0a3d62; /* Dark Blue */
       --app-secondary: #1e90ff; /* Light Blue */
    }

    body {
      background-image: url('https://raw.githubusercontent.com/bini2024/Eri-shipping-Hub/refs/heads/main/Erishipping.jpg');
      background-size: cover;
      background-position: center center;
      background-attachment: fixed;
      min-height: 100vh;
      margin: 0;
      padding-bottom: 90px; /* Space for bottom nav */
    }

    /* --- Typography & Header --- */
    header h1 .nav-brand {
         color: var(--app-secondary) !important;
         font-weight: 700;
     }
     header h1, header p {
         text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
         color: var(--app-primary) !important; 
     }
     header {
         background: none !important;
     }

    /* --- Form Card Styles --- */
    .form-card {
        background-color: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(8px);
        border: none;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        border-top: 5px solid var(--app-secondary);
        padding: 25px;
        margin-bottom: 30px;
    }

    /* --- Input Field Styling (High Visibility) --- */
    .form-label {
        font-weight: 600;
        color: var(--app-primary);
        font-size: 0.9rem;
        margin-bottom: 4px;
    }
    
    .form-control, .form-select {
        border: 1px solid #adb5bd !important; /* Visible Border */
        background-color: #fff;
        padding: 10px;
        border-radius: 8px;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: var(--app-primary) !important;
        box-shadow: 0 0 0 0.25rem rgba(10, 61, 98, 0.25);
    }

    /* --- Load List Cards --- */
    .load-card {
        transition: transform 0.2s, box-shadow 0.2s;
        border: none;
        border-radius: 12px;
        background-color: rgba(255, 255, 255, 0.95);
        border-left: 4px solid #ffc107; /* Yellow warning color for "Needs Package" */
        height: 100%;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .load-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.15);
    }
    .card-title {
        color: var(--app-primary);
        font-weight: 700;
    }

    /* --- Buttons --- */
    .btn-primary {
        background-color: var(--app-primary);
        border-color: var(--app-primary);
        font-weight: bold;
        padding: 12px;
        border-radius: 50px;
    }
    .btn-primary:hover {
        background-color: var(--app-secondary);
        border-color: var(--app-secondary);
    }

    /* --- Select2 Customization --- */
    .select2-container--bootstrap-5 .select2-selection {
        border-color: #adb5bd !important; /* Visible Border */
        padding-top: 0.4rem;
        padding-bottom: 0.4rem;
        border-radius: 8px;
    }
    .select2-container--bootstrap-5 .select2-selection.is-invalid {
        border-color: #dc3545 !important;
    }

    /* --- Bottom Navigation Bar --- */
    .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background-color: var(--app-primary);
        display: flex;
        justify-content: space-around;
        align-items: center;
        padding: 10px 0;
        z-index: 2000;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
        border-top: 1px solid rgba(255,255,255,0.1);
    }
    .bottom-nav a {
        color: rgba(255,255,255,0.6);
        text-decoration: none;
        text-align: center;
        font-size: 0.8rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        transition: color 0.3s;
    }
    .bottom-nav a i {
        font-size: 1.2rem;
        margin-bottom: 4px;
    }
    .bottom-nav a:hover, .bottom-nav a.active {
        color: white;
    }
    .bottom-nav a.active i {
        color: var(--app-secondary);
    }

    /* Loading State */
    .btn .spinner-border { display: none; margin-right: 0.5rem; }
    .btn.loading .spinner-border { display: inline-block; }
    .btn.loading .button-text { display: none; }

    /* Logo */
    #siteLogo {
       position: fixed;
       top: 16px;
       left: 16px;
       width: 48px;
       height: auto;
       z-index: 1000;
    }
  </style>
</head>
<body>

  <header class="py-4 mb-2">
    <div class="container text-center">
        <img id="siteLogo" src="1000072056-removebg-preview.png" alt="Eri Shipping Hub Logo">
      <h1 class="mb-2">
        <i class="fas fa-shipping-fast" style="color: var(--app-primary);"></i>
        <span class="nav-brand">Eri Shipping Hub</span>
      </h1>
      <p>Our community, our courier</p>
    </div>
  </header>

  <div class="container">
     <div id="generalFeedback" class="alert alert-info alert-dismissible fade d-none" role="alert">
        <span id="generalFeedbackText"></span>
        <button type="button" class="btn-close" aria-label="Close"></button>
    </div>
  </div>

  <div class="container py-2">
    
    <section class="form-card mx-auto" style="max-width: 800px;">
        <h4 class="text-center mb-4" style="color: var(--app-primary); font-weight: 700;">
            <i class="fas fa-box-open me-2"></i>Post a Load (áŠ•á‰¥áˆ¨á‰µ áŠ£áˆˆáŠ’)
        </h4>
        <form id="loadForm" novalidate>
            <div class="row g-3">
                <div class="col-md-6">
                    <label for="from" class="form-label">From (áŠ«á‰¥)</label>
                    <select id="from" class="form-select" required>
                        <option value="" disabled selected>Select Origin</option>
                         <option value="Ethiopia">ğŸ‡ªğŸ‡¹ Ethiopia</option>
                         <option value="Eritrea">ğŸ‡ªğŸ‡· Eritrea</option>
                         <option value="Uganda">ğŸ‡ºğŸ‡¬ Uganda</option>
                         <option value="Canada">ğŸ‡¨ğŸ‡¦ Canada</option>
                         <option value="Turkey">ğŸ‡¹ğŸ‡· Turkey</option>
                         <option value="Dubai">ğŸ‡¦ğŸ‡ª Dubai</option>
                         <option value="Kenya">ğŸ‡°ğŸ‡ª Kenya</option>
                         <option value="Angola">ğŸ‡¦ğŸ‡´ Angola</option>
                         <option value="Switzerland">ğŸ‡¨ğŸ‡­ Switzerland</option>
                         <option value="Netherlands">ğŸ‡³ğŸ‡± Netherlands</option>
                         <option value="Belgium">ğŸ‡§ğŸ‡ª Belgium</option>
                         <option value="Sweden">ğŸ‡¸ğŸ‡ª Sweden</option>
                         <option value="Germany">ğŸ‡©ğŸ‡ª Germany</option>
                         <option value="USA">ğŸ‡ºğŸ‡¸ USA</option>
                         <option value="England">ğŸ‡¬ğŸ‡§ England</option>
                         <option value="Denmark">ğŸ‡©ğŸ‡° Denmark</option>
                         <option value="France">ğŸ‡«ğŸ‡· France</option>
                         <option value="Italy">ğŸ‡®ğŸ‡¹ Italy</option>
                         <option value="South Africa">ğŸ‡¿ğŸ‡¦ South Africa</option>
                         <option value="Egypt">ğŸ‡ªğŸ‡¬ Egypt</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="to" class="form-label">To (áŠ“á‰¥)</label>
                    <select id="to" class="form-select" required>
                        <option value="" disabled selected>Select Destination</option>
                         <option value="Ethiopia">ğŸ‡ªğŸ‡¹ Ethiopia</option>
                         <option value="Eritrea">ğŸ‡ªğŸ‡· Eritrea</option>
                         <option value="Uganda">ğŸ‡ºğŸ‡¬ Uganda</option>
                         <option value="Canada">ğŸ‡¨ğŸ‡¦ Canada</option>
                         <option value="Turkey">ğŸ‡¹ğŸ‡· Turkey</option>
                         <option value="Dubai">ğŸ‡¦ğŸ‡ª Dubai</option>
                         <option value="Kenya">ğŸ‡°ğŸ‡ª Kenya</option>
                         <option value="Angola">ğŸ‡¦ğŸ‡´ Angola</option>
                         <option value="Switzerland">ğŸ‡¨ğŸ‡­ Switzerland</option>
                         <option value="Netherlands">ğŸ‡³ğŸ‡± Netherlands</option>
                         <option value="Belgium">ğŸ‡§ğŸ‡ª Belgium</option>
                         <option value="Sweden">ğŸ‡¸ğŸ‡ª Sweden</option>
                         <option value="Germany">ğŸ‡©ğŸ‡ª Germany</option>
                         <option value="USA">ğŸ‡ºğŸ‡¸ USA</option>
                         <option value="England">ğŸ‡¬ğŸ‡§ England</option>
                         <option value="Denmark">ğŸ‡©ğŸ‡° Denmark</option>
                         <option value="France">ğŸ‡«ğŸ‡· France</option>
                         <option value="Italy">ğŸ‡®ğŸ‡¹ Italy</option>
                         <option value="South Africa">ğŸ‡¿ğŸ‡¦ South Africa</option>
                         <option value="Egypt">ğŸ‡ªğŸ‡¬ Egypt</option>
                    </select>
                </div>

                <div class="col-md-4">
                     <label for="weight" class="form-label">Weight (áŠªáˆ)</label>
                     <input type="text" id="weight" class="form-control" placeholder="e.g. 5 kg" required />
                </div>
                <div class="col-md-4">
                     <label for="deadline" class="form-label">Deadline (á‰…á‹µáˆš)</label>
                     <input type="date" id="deadline" class="form-control" required />
                </div>
                <div class="col-md-4">
                     <label for="phone" class="form-label">Phone (á‰´áˆŒááŠ•)</label>
                     <input type="tel" id="phone" class="form-control" placeholder="+1..." required />
                </div>

                <div class="col-12">
                     <label for="comment" class="form-label">Note (á‰°á‹ˆáˆ³áŠª áˆ“á‰ áˆ¬á‰³)</label>
                     <textarea id="comment" class="form-control" placeholder="What is inside the package?"></textarea>
                </div>
            </div>

            <div class="form-check mt-3 mb-3">
                 <input class="form-check-input" type="checkbox" value="" id="agreeToTermsCheckbox">
                 <label class="form-check-label" for="agreeToTermsCheckbox">
                   I agree to the <a href="terms.html" target="_blank" style="color:var(--app-secondary); font-weight:bold;">Terms & Conditions</a>
                 </label>
            </div>

            <button id="submitLoadBtn" class="btn btn-primary w-100" type="submit">
                 <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                 <span class="button-text">Post Load (áŠ•á‰¥áˆ¨á‰µ áˆ˜á‹áŒá‰¥)</span>
            </button>
        </form>
    </section>

    <section>
      <div class="d-flex justify-content-center mb-4">
          <span style="background: var(--app-primary); color: white; padding: 0.6rem 2rem; border-radius: 50px; font-weight:bold; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">
            ğŸ“‹ Available Loads (á‹á‹áˆ°á‹µ áŠ•á‰¥áˆ¨á‰µ)
          </span>
      </div>
      
      <div id="loadList" class="row gy-4">
          </div>
    </section>
  </div>

  <nav class="bottom-nav">
      <a href="index.html">
          <i class="fas fa-home"></i>
          Home
      </a>
      <a href="register.html">
          <i class="fas fa-plane-departure"></i>
          Post Trip
      </a>
      <a href="load-board.html" class="active">
          <i class="fas fa-box-open"></i>
          Load Board
      </a>
      <a href="https://t.me/Erishipping" target="_blank">
          <i class="fab fa-telegram-plane"></i>
          Support
      </a>
  </nav>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, deleteDoc, doc, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCapqLcvAVvBtSvUgtvLX4gx7nN5XSjAtQ", 
      authDomain: "erishipping-e4532.firebaseapp.com",
      projectId: "erishipping-e4532",
      storageBucket: "erishipping-e4532.appspot.com",
      messagingSenderId: "388550131049",
      appId: "1:388550131049:web:e9ac1784ab8e5fabc811f8"
    };

    const app = getApps().length === 0 ? initializeApp(firebaseConfig) : getApp();
    const db = getFirestore(app);
    const auth = getAuth(app);
    const loadRef = collection(db, "loads");

    // UI Elements
    const form = document.getElementById("loadForm");
    const loadList = document.getElementById("loadList");
    const submitLoadBtn = document.getElementById("submitLoadBtn");
    const generalFeedback = document.getElementById("generalFeedback");
    const generalFeedbackText = document.getElementById("generalFeedbackText");
    const agreeToTermsCheckbox = document.getElementById('agreeToTermsCheckbox');
    
    let isAdmin = false;
    let currentSnapshot = null;
    let feedbackHideTimeout = null;

    // --- Helpers ---
    function showGeneralFeedback(message, type = 'info', duration = 7000) {
        if (feedbackHideTimeout) clearTimeout(feedbackHideTimeout);
        generalFeedback.classList.remove('d-none', 'alert-info', 'alert-success', 'alert-warning', 'alert-danger');
        generalFeedback.classList.add(`alert-${type}`, 'show');
        generalFeedbackText.textContent = message;
        feedbackHideTimeout = setTimeout(() => {
            generalFeedback.classList.remove('show');
            setTimeout(() => generalFeedback.classList.add('d-none'), 300);
        }, duration);
    }

    function setButtonLoadingState(button, isLoading) {
        button.disabled = isLoading;
        if (isLoading) button.classList.add('loading');
        else button.classList.remove('loading');
    }

    function setValidationFeedback(inputElement, message = '') {
        const isSelect2 = $(inputElement).hasClass('select2-hidden-accessible');
        const targetElement = isSelect2 ? $(inputElement).next('.select2-container').find('.select2-selection') : $(inputElement);
        if (message) targetElement.addClass('is-invalid');
        else targetElement.removeClass('is-invalid');
    }

    function clearAllValidationFeedback() {
        form.querySelectorAll('.form-control, .form-select').forEach(input => setValidationFeedback(input, ''));
        $('.select2-selection').removeClass('is-invalid');
    }

    // --- Auth Listener ---
    onAuthStateChanged(auth, (user) => {
        isAdmin = !!user;
        if (currentSnapshot) renderLoads(currentSnapshot);
    });

    // --- Submit Logic ---
    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        clearAllValidationFeedback();

        const from = $('#from').val();
        const to = $('#to').val();
        const weight = form.weight.value.trim();
        const deadline = form.deadline.value;
        const phone = form.phone.value.trim();
        const comment = form.comment.value.trim();

        let isValid = true;
        if (!agreeToTermsCheckbox.checked) { showGeneralFeedback("Agree to terms required.", "warning"); isValid = false; }
        if (!from) { setValidationFeedback(form.from, "Req"); isValid = false; }
        if (!to) { setValidationFeedback(form.to, "Req"); isValid = false; }
        if (!weight || isNaN(parseFloat(weight))) { setValidationFeedback(form.weight, "Req"); isValid = false; }
        if (!deadline) { setValidationFeedback(form.deadline, "Req"); isValid = false; }
        if (!phone) { setValidationFeedback(form.phone, "Req"); isValid = false; }

        if (!isValid) return;

        setButtonLoadingState(submitLoadBtn, true);

        try {
            // Cooldown Check
            const lastPostTime = localStorage.getItem("lastLoadPostTime");
            const cooldownDuration = 2 * 60 * 60 * 1000;
            const currentTime = Date.now();
            if (!isAdmin && lastPostTime && (currentTime - parseInt(lastPostTime) < cooldownDuration)) {
                 const minutes = Math.ceil((cooldownDuration - (currentTime - parseInt(lastPostTime))) / 60000);
                 throw new Error(`Please wait ${minutes} mins before posting again.`);
            }

            // Duplicate Check
            const dupQuery = query(loadRef, where("from","==",from), where("to","==",to), where("deadline","==",deadline), where("phone","==",phone));
            const existing = await getDocs(dupQuery);
            if (!existing.empty) throw new Error("This load is already posted.");

            await addDoc(loadRef, {
                from, to, weight: parseFloat(weight), deadline, phone, comment,
                createdAt: serverTimestamp()
            });

            if (!isAdmin) localStorage.setItem("lastLoadPostTime", currentTime);
            
            form.reset();
            $('#from, #to').val(null).trigger('change');
            agreeToTermsCheckbox.checked = false;
            showGeneralFeedback("âœ… Load posted successfully!", "success");

        } catch (error) {
            console.error(error);
            showGeneralFeedback(error.message, "danger");
        } finally {
            setButtonLoadingState(submitLoadBtn, false);
        }
    });

    // --- Render Logic ---
    function renderLoads(snapshot) {
        currentSnapshot = snapshot;
        loadList.innerHTML = "";
        const now = new Date();
        now.setHours(0,0,0,0);
        let hasLoads = false;

        if (snapshot.empty) {
            loadList.innerHTML = `<div class="col-12 text-center text-muted"><p class="fs-5">ğŸ“­ No loads available.</p></div>`;
            return;
        }

        snapshot.forEach(docSnap => {
            const load = docSnap.data();
            const deadlineDate = load.deadline ? new Date(load.deadline + 'T00:00:00') : null;

            if (!deadlineDate || deadlineDate < now) return; // Skip expired
            hasLoads = true;

            const div = document.createElement("div");
            div.className = "col-lg-4 col-md-6 mb-4";
            div.innerHTML = `
              <div class="card h-100 load-card shadow-sm">
                <div class="card-body d-flex flex-column">
                  <div class="d-flex justify-content-between mb-2">
                     <span class="badge bg-warning text-dark"><i class="fas fa-weight-hanging"></i> ${load.weight} kg</span>
                     <small class="text-muted">${load.deadline}</small>
                  </div>
                  <h5 class="card-title text-center my-2">${load.from} <i class="fas fa-arrow-right mx-2 text-primary"></i> ${load.to}</h5>
                  <hr class="my-2">
                  <p class="mb-1"><i class="fas fa-phone me-2 text-success"></i><a href="tel:${load.phone}" class="text-decoration-none text-dark fw-bold">${load.phone}</a></p>
                  <p class="mb-3 flex-grow-1 text-muted small"><i class="fas fa-sticky-note me-2"></i>${load.comment || "No details."}</p>
                  
                  ${isAdmin ? `<button class="btn btn-sm btn-outline-danger mt-auto delete-load-btn w-100" data-id="${docSnap.id}">Delete</button>` : ""}
                </div>
              </div>
            `;
            loadList.appendChild(div);
        });

        if (!hasLoads) loadList.innerHTML = `<div class="col-12 text-center text-muted"><p>ğŸ“­ No active loads found.</p></div>`;
    }

    // --- Listener ---
    const loadsQuery = query(loadRef, orderBy("createdAt", "desc"));
    onSnapshot(loadsQuery, renderLoads);

    // --- Delete (Admin UI) ---
    loadList.addEventListener('click', async (e) => {
        if (e.target.classList.contains('delete-load-btn')) {
            if (!confirm("Delete this load?")) return;
            const id = e.target.dataset.id;
            try {
                await deleteDoc(doc(loadRef, id));
                showGeneralFeedback("Deleted.", "success");
            } catch (err) {
                showGeneralFeedback("Failed to delete.", "danger");
            }
        }
    });

    // --- Select2 Init ---
    $(document).ready(function() {
        $('#from, #to').select2({ theme: 'bootstrap-5', width: '100%' });
        
        $('#from, #to').on('change', function() {
            if($(this).val()) setValidationFeedback(this, '');
        });
        
        form.querySelectorAll('input').forEach(input => {
             input.addEventListener('input', () => setValidationFeedback(input, ''));
        });
    });

  </script>
</body>
</html>
